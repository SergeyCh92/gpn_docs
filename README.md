# Схема деплоя и настройки сервисов

1. Склонировать следующие репозитории в одну директорию:
    - https://github.com/SergeyCh92/vlp.git
    - https://github.com/SergeyCh92/ipr.git
    - https://github.com/SergeyCh92/nodal_analysis.git
    - https://github.com/SergeyCh92/gateway.git
    - https://github.com/SergeyCh92/common.git
2. Скопировать docker-compose.yaml в папку, в которой находятся директории, содержащие код сервисов.
Т.е. файл docker-compose должен быть на одном уровне с директориями, в противном случае задеплоить
сервисы не удастся.
3. Убедиться, что на ПК установлен python 3.11.1, при необходимости установить.
4. Открыть директорию, в которую был склонирован репозиторий https://github.com/SergeyCh92/gateway.git.
5. Поднять виртуальное окружение (инструкция в репозитории).
6. Поднять БД (postgresql). Это можно сделать, закомментив в docker-compose.yaml все сервисы, кроме postgres.
Команда docker-compose up -d.
7. Выполнить миграции в gateway_service (инструкция в репозитории).
8. Гасим контейнер (docker-compose down). Раскомментируем сервисы, которые ранее закомментировали.
9. На одном уровне с docker-compose.yaml создаем папку RabbitMQ. Переходим в нее.
10. Создаем папку certs. Копируем в нее файд rabbitmq.conf.
11. Открываем web-интерфейс RabbitMQ (для этого переходим по ссылке http://localhost:15672). Логин и пароль
можно найти в docker-compose.yaml.
12. Создаем exchange с именем gpn_exchange, тип direct. Создаем 3 очереди с именами vlp, ipr, nodal_analysis.
Routing key должен соответствовать наименованию очереди. Привязываем очереди к ранее созданному exchange.
Важно выбирать только те наименования, которые указаны в данной инструкции, т.к. именно эти имена зашиты как
дефолтные при чтении переменных окружения.
13. Возвращаемся на уровень, где расположен docker-compose.yaml, выполняем команду docker-compose up -d.
14. Открываем http://localhost:5007/docs.
15. Открываем роут create_task и отправляем запрос (пример запроса можно найти в файле request_example.json).
16. Получить статус и результат задачи можно через роут get_task.

Дополнительно:
Ознакомиться с графической схемой взаимодействия сервисов можно, открыв файл "схема сервисов.drawio.png".